{% extends "base.html" %}
{% block title %}Git Repository - {{ repository.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="{% url 'git-settings' %}" class="text-muted-foreground hover:text-foreground">
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </a>
      <div>
        <h1 class="text-2xl font-bold tracking-tight">{{ repository.name }}</h1>
        <p class="text-muted-foreground">{{ repository.customer.name }} â€¢ {{ repository.remote_url }}</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button hx-post="{% url 'git-test-connection' repository.pk %}"
              hx-target="#test-result"
              hx-swap="innerHTML"
              class="inline-flex items-center justify-center rounded-md border px-4 py-2 text-sm font-medium hover:bg-muted">
        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Test Connection
      </button>
      <button hx-post="{% url 'git-sync' repository.pk %}"
              hx-target="#sync-result"
              hx-swap="innerHTML"
              class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">
        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Sync Now
      </button>
    </div>
  </div>

  <div id="test-result"></div>
  <div id="sync-result"></div>

  <div class="grid gap-6 lg:grid-cols-2">
    <!-- Configuration Form -->
    <div class="rounded-lg border bg-card">
      <div class="border-b px-6 py-4">
        <h2 class="text-lg font-medium">Configuration</h2>
      </div>
      <form method="post" class="p-6 space-y-4">
        {% csrf_token %}
        {% include "settings/_git_form.html" %}
        <div class="flex items-center justify-between pt-4 border-t">
          <form method="post" action="{% url 'git-settings-delete' repository.pk %}">
            {% csrf_token %}
            <button type="submit" onclick="return confirm('Are you sure you want to delete this repository?')"
                    class="inline-flex items-center justify-center rounded-md border border-red-200 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:border-red-800 dark:text-red-400 dark:hover:bg-red-950">
              Delete
            </button>
          </form>
          <button type="submit"
                  class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">
            Save Changes
          </button>
        </div>
      </form>
    </div>

    <!-- Status & Info -->
    <div class="space-y-6">
      <!-- Sync Status -->
      <div class="rounded-lg border bg-card">
        <div class="border-b px-6 py-4">
          <h2 class="text-lg font-medium">Sync Status</h2>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-muted-foreground">Status</p>
              <p class="font-medium">
                {% if repository.enabled %}
                  <span class="text-green-600">Enabled</span>
                {% else %}
                  <span class="text-gray-600">Disabled</span>
                {% endif %}
              </p>
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Last Sync</p>
              <p class="font-medium">
                {% if repository.last_sync_at %}
                  {{ repository.last_sync_at|timesince }} ago
                {% else %}
                  Never
                {% endif %}
              </p>
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Last Result</p>
              <p class="font-medium">
                {% if repository.last_sync_status == 'success' %}
                  <span class="text-green-600">Success</span>
                {% elif repository.last_sync_status == 'failed' %}
                  <span class="text-red-600">Failed</span>
                {% else %}
                  <span class="text-gray-600">-</span>
                {% endif %}
              </p>
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Path Structure</p>
              <p class="font-medium">{{ repository.get_path_structure_display }}</p>
            </div>
          </div>
          {% if repository.last_sync_message %}
          <div class="pt-4 border-t">
            <p class="text-sm text-muted-foreground">Last Message</p>
            <p class="mt-1 text-sm font-mono bg-muted p-2 rounded">{{ repository.last_sync_message|truncatechars:200 }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Recent Sync Logs -->
      <div class="rounded-lg border bg-card">
        <div class="flex items-center justify-between border-b px-6 py-4">
          <h2 class="text-lg font-medium">Recent Syncs</h2>
          <a href="{% url 'git-sync-logs' repository.pk %}" class="text-sm text-primary hover:underline">
            View All
          </a>
        </div>
        <div class="p-6">
          {% if sync_logs %}
          <div class="space-y-3">
            {% for log in sync_logs %}
            <div class="flex items-center justify-between py-2 border-b last:border-0">
              <div>
                <div class="flex items-center gap-2">
                  {% if log.status == 'success' %}
                    <span class="h-2 w-2 rounded-full bg-green-500"></span>
                  {% elif log.status == 'failed' %}
                    <span class="h-2 w-2 rounded-full bg-red-500"></span>
                  {% elif log.status == 'running' %}
                    <span class="h-2 w-2 rounded-full bg-yellow-500 animate-pulse"></span>
                  {% else %}
                    <span class="h-2 w-2 rounded-full bg-gray-400"></span>
                  {% endif %}
                  <span class="text-sm">{{ log.started_at|date:"M d, H:i" }}</span>
                </div>
                {% if log.commit_hash %}
                <p class="mt-1 text-xs font-mono text-muted-foreground">{{ log.commit_hash|slice:":7" }}</p>
                {% endif %}
              </div>
              <div class="text-right text-sm">
                <span>{{ log.files_synced }} file{% if log.files_synced != 1 %}s{% endif %}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-sm text-muted-foreground">No sync history yet</p>
          {% endif %}
        </div>
      </div>

      <!-- External Links -->
      {% if repository.remote_url %}
      <div class="rounded-lg border bg-card p-6">
        <h2 class="text-lg font-medium mb-4">External Links</h2>
        <a href="{{ repository.remote_url }}" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center text-sm text-primary hover:underline">
          <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
          Open in Git Provider
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
