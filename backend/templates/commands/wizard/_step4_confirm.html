<!-- Step 4: Preview & Confirm -->
<div class="space-y-4">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h3 class="text-lg font-medium text-foreground">Review & Confirm</h3>
      <p class="text-sm text-muted-foreground">Review your task configuration before submitting</p>
    </div>
    <span class="text-xs text-muted-foreground">Step 4 of 4</span>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Task Summary -->
    <div class="form-section p-4">
      <h4 class="text-sm font-medium text-foreground mb-3 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Task Details
      </h4>
      <dl class="space-y-2">
        <div class="flex justify-between text-sm">
          <dt class="text-muted-foreground">Library:</dt>
          <dd class="font-medium text-foreground">NAPALM</dd>
        </div>
        <div class="flex justify-between text-sm">
          <dt class="text-muted-foreground">Task:</dt>
          <dd class="font-medium text-foreground">Get Facts</dd>
        </div>
        <div class="flex justify-between text-sm">
          <dt class="text-muted-foreground">Execution:</dt>
          <dd class="font-medium text-foreground">Parallel</dd>
        </div>
        <div class="flex justify-between text-sm">
          <dt class="text-muted-foreground">Timeout:</dt>
          <dd class="font-medium text-foreground">30s</dd>
        </div>
      </dl>
    </div>

    <!-- Scope Summary -->
    <div class="form-section p-4">
      <h4 class="text-sm font-medium text-foreground mb-3 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
        </svg>
        Target Devices
      </h4>
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-muted-foreground">Selected devices:</span>
        <span class="badge badge-primary" id="confirm-device-count">0</span>
      </div>
      <div class="mt-2 max-h-32 overflow-y-auto">
        <div class="space-y-1" id="confirm-device-list">
          <!-- Will be populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Parameters Preview -->
  <div class="form-section p-4">
    <h4 class="text-sm font-medium text-foreground mb-3 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
      </svg>
      Command
    </h4>
    <pre class="bg-muted rounded p-3 text-xs font-mono overflow-x-auto" id="confirm-command">show running-config</pre>
  </div>

  <!-- Warning Banner -->
  <div class="rounded-lg bg-warning/10 border border-warning/20 p-4">
    <div class="flex items-start gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-warning flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div>
        <h4 class="text-sm font-medium text-foreground">Important</h4>
        <p class="text-xs text-muted-foreground mt-1">
          This task will be executed on <strong id="confirm-final-count">0</strong> device(s). 
          Make sure to review the configuration commands before proceeding.
        </p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="flex justify-between gap-2 pt-4 border-t">
    <button type="button" onclick="loadWizardStep('parameters')" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    </button>
    <div class="flex gap-2">
      <button type="button" onclick="closeRunTaskWizard()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4">
        Cancel
      </button>
      <button type="button" onclick="submitTask()" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Submit Task
      </button>
    </div>
  </div>
</div>

<script>
// Populate confirmation details
const selectedDevices = getSelectedDeviceIds();
const confirmDeviceCount = document.getElementById('confirm-device-count');
const confirmDeviceList = document.getElementById('confirm-device-list');
const confirmFinalCount = document.getElementById('confirm-final-count');

confirmDeviceCount.textContent = selectedDevices.length;
confirmFinalCount.textContent = selectedDevices.length;

selectedDevices.forEach(deviceId => {
  const checkbox = document.querySelector(`.device-checkbox[data-device-id="${deviceId}"]`);
  if (checkbox) {
    const hostname = checkbox.dataset.deviceHostname;
    const item = document.createElement('div');
    item.className = 'flex items-center gap-2 text-xs';
    item.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <span class="text-foreground">${hostname}</span>
    `;
    confirmDeviceList.appendChild(item);
  }
});

function submitTask() {
  const deviceIds = getSelectedDeviceIds();
  
  if (deviceIds.length === 0) {
    alert('No devices selected');
    return;
  }
  
  // TODO: Implement task submission API call
  htmx.ajax('POST', '/api/commands/run', {
    values: {
      device_ids: deviceIds,
      task_type: wizardData.taskType,
      task_name: wizardData.taskName,
      parameters: JSON.stringify(wizardData.parameters)
    },
    swap: 'none'
  }).then((response) => {
    alert('Task submitted successfully! Job ID: ' + (response.job_id || 'N/A'));
    closeRunTaskWizard();
    clearSelection();
    // Optionally redirect to jobs page
    // window.location.href = '/jobs/';
  }).catch((error) => {
    alert('Error submitting task: ' + error.message);
  });
}
</script>
